# Wireguard configuration for {{ inventory_hostname }}
# Auto-generated by Ansible - do not edit manually

[Interface]
Address = {{ wg_interface_addr }}/24
PrivateKey = {{ private_key }}
ListenPort = {{ wg_port }}
SaveConfig = false

{% if is_endpoint %}
# lab-proxy specific configuration
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
{% endif %}

# Peer configurations
{% for host, pubkey in public_keys.items() %}
{% if host != inventory_hostname %}

[Peer]
# {{ host }}
PublicKey = {{ pubkey }}
PersistentKeepalive = 25

{% if host == 'lab-proxy' and inventory_hostname != 'soundship' %}
#
Endpoint = {{ public_endpoint }}
PersistentKeepalive = 25
{% endif %}

{% if host == 'macbook-air' %}
AllowedIPs = 10.1.0.100/32
{% else %}

{% set wg_addr = hostvars[host]['wg_addr'] | default('10.1.0.254') %}
AllowedIPs = {{ wg_addr }}/32
{% endif %}

{% endif %}
{% endfor %}
