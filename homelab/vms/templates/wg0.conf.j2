# Wireguard configuration for {{ inventory_hostname }}
# Auto-generated by Ansible - do not edit manually

[Interface]
Address = {{ wg_vpn_ip }}/24
PrivateKey = {{ private_key }}
ListenPort = {{ wg_port }}
SaveConfig = false

# Uncomment to proxy requests to other hsots on the network
# PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
# PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

# Peer configurations
{% for host, pubkey in public_keys.items() %}
{% if host != inventory_hostname %}

[Peer]
# {{ host }}
PublicKey = {{ pubkey }}
PersistentKeepalive = 25
{% if host == 'macbook-air' %}
AllowedIPs = 10.1.0.100/32
{% else %}
{% if hostvars[host]['wg_endpoint_ip'] | default(none) is not none %}
Endpoint = {{ hostvars[host]['wg_endpoint_ip'] }}:{{wg_port}}
{% endif %}
{% if hostvars[host]['wg_vpn_ip'] | default(none) is not none %}
AllowedIPs = {{ hostvars[host]['wg_vpn_ip'] }}/32
{% endif %}
{% endif %}


{% endif %}
{% endfor %}
