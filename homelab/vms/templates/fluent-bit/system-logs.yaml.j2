---
pipeline:
  inputs:
    # Container logs from rootless nerdctl
    # Path pattern: /home/<user>/.local/share/nerdctl/<namespace_id>/containers/default/<container_id>/<container_id>-json.log
    - name: tail
      path: /home/*/.local/share/nerdctl/*/containers/default/*/*-json.log
      tag: container.*
      db: /var/lib/fluent-bit/container.db
      parser: docker
      path_key: filepath
      refresh_interval: 5
      read_from_head: false

  filters:
    # Process container logs: extract container info and resolve names
    - name: lua
      match: container.*
      script: /etc/fluent-bit/process-container-logs.lua
      call: process_container_logs

  outputs:
    - name: loki
      match: container.*
      host: {{ logging_endpoint_ip | default('10.0.0.2') }}
      port: {{ logging_endpoint_port | default(3100) }}
      labels: job=container, host={{ inventory_hostname }}, container_name=$container_name, container_id=$container_id, user=$container_user
      line_format: json
      workers: 2

---
pipeline:
  inputs:
    - name: tail
      path: /var/log/laurel/audit.log
      tag: audit.*
      db: /var/lib/fluent-bit/audit.db
      processors:
        logs:
          - name: content_modifier
            action: extract
            key: log
            pattern: ^{"ID":"[\d.:]+","(?<action>\w+)":.*$

  filters:
    - name: parser
      match: audit.*
      key_name: log
      parser: audit_json_parser
      reserve_data: on

  outputs:
    - name: loki
      match: audit.*
      host: {{ logging_endpoint_ip | default('10.0.0.2') }}
      port: {{ logging_endpoint_port | default(3100) }}
      labels: job=audit, host={{ inventory_hostname }}, action=$action
      line_format: json
      workers: 2
